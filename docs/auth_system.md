# Система аутентификации и авторизации

## Обзор

Система аутентификации Trivia API обеспечивает безопасный доступ к ресурсам приложения с поддержкой современных практик безопасности. Она построена на многоуровневой архитектуре с комбинацией JWT (JSON Web Tokens) и refresh-токенов для обеспечения безопасности и удобства пользователей.

## Архитектура

Система аутентификации состоит из следующих ключевых компонентов:

```
┌───────────────┐      ┌────────────────┐      ┌─────────────────┐
│  TokenManager ├─────►│   JWTService   ├─────►│ InvalidTokenRepo │
└───────┬───────┘      └────────────────┘      └─────────────────┘
        │
        │              ┌────────────────┐      ┌─────────────────┐
        └─────────────►│  TokenService  ├─────►│ RefreshTokenRepo │
                       └────────────────┘      └─────────────────┘
```

### TokenManager

TokenManager - это высокоуровневый компонент, представляющий собой "фасад" системы аутентификации, который:

- Объединяет работу JWTService и TokenService
- Управляет жизненным циклом токенов
- Реализует управление CSRF-токенами
- Обеспечивает ротацию JWT-ключей
- Предоставляет унифицированный API для других компонентов системы

### JWTService

JWTService отвечает за работу с JWT токенами:

- Генерация JWT-токенов с пользовательскими клеймами
- Проверка подписи и валидности токенов
- Обработка инвалидации токенов
- Двухуровневая система проверки инвалидации (in-memory + база данных)
- Диагностика токенов для отладки

### TokenService

TokenService отвечает за работу с refresh-токенами:

- Управление парой токенов (JWT access token + refresh token)
- Генерация криптографически стойких refresh-токенов
- Привязка refresh-токенов к устройствам пользователя
- Лимитирование количества активных сессий на пользователя
- Обновление токенов без ввода пароля

### Репозитории

- **InvalidTokenRepo** - хранение и доступ к инвалидированным токенам
- **RefreshTokenRepo** - хранение и управление refresh-токенами

## Два режима аутентификации

Система поддерживает два режима аутентификации для обеспечения гибкости и различных сценариев использования:

### 1. Cookie-Based Authentication (рекомендуемый)

- Access token хранится в HttpOnly cookie
- CSRF-токен передается в заголовке для защиты от CSRF-атак
- Поддерживает SameSite=Strict для дополнительной безопасности
- Refresh token также хранится в HttpOnly cookie
- Более безопасный вариант для веб-приложений

```
┌─────────────┐                  ┌──────────────┐                 ┌──────────────┐
│   Браузер   │                  │   Frontend   │                 │    Backend   │
└──────┬──────┘                  └──────┬───────┘                 └──────┬───────┘
       │                                │                                │
       │  HTTP запрос                   │                                │
       ├───────────────────────────────►│                                │
       │                                │                                │
       │                                │  POST /api/auth/login          │
       │                                ├───────────────────────────────►│
       │                                │                                │
       │                                │  Set-Cookie: access_token=...  │
       │                                │  Set-Cookie: refresh_token=... │
       │                                │  + CSRF token в теле ответа    │
       │                                │◄───────────────────────────────┤
       │                                │                                │
       │  Cookies сохраняются автом.    │                                │
       │◄───────────────────────────────┤                                │
       │                                │                                │
       │  API запрос + автом. cookies   │                                │
       │  + X-CSRF-Token в заголовке    │                                │
       ├───────────────────────────────►│                                │
       │                                │                                │
       │                                │  API запрос + Cookie           │
       │                                │  + X-CSRF-Token в заголовке    │
       │                                ├───────────────────────────────►│
       │                                │                                │
```

### 2. Bearer Token Authentication

- Access и refresh токены передаются через тело ответов
- Access token передается в заголовке Authorization с префиксом "Bearer"
- Клиент самостоятельно хранит токены (локальное хранилище, и т.д.)
- Большая гибкость для мобильных и других non-browser клиентов

```
┌─────────────┐                  ┌──────────────┐                 ┌──────────────┐
│   Клиент    │                  │   Frontend   │                 │    Backend   │
└──────┬──────┘                  └──────┬───────┘                 └──────┬───────┘
       │                                │                                │
       │  HTTP запрос                   │                                │
       ├───────────────────────────────►│                                │
       │                                │                                │
       │                                │  POST /api/auth/login          │
       │                                ├───────────────────────────────►│
       │                                │                                │
       │                                │  JSON: { access_token, ...}    │
       │                                │◄───────────────────────────────┤
       │                                │                                │
       │  Токены в JSON ответе          │                                │
       │◄───────────────────────────────┤                                │
       │                                │                                │
       │  Клиент сохраняет токены       │                                │
       │                                │                                │
       │  API запрос +                  │                                │
       │  Authorization: Bearer token   │                                │
       ├───────────────────────────────►│                                │
       │                                │                                │
       │                                │  API запрос +                  │
       │                                │  Authorization: Bearer token   │
       │                                ├───────────────────────────────►│
       │                                │                                │
```

## Жизненный цикл токенов

### Access Token (JWT)

- Короткое время жизни (30 минут по умолчанию)
- Содержит идентификатор пользователя и другие claim'ы
- Подписан секретным ключом сервера
- Используется для авторизации запросов
- Может быть инвалидирован через систему инвалидации

### Refresh Token

- Длительное время жизни (30 дней по умолчанию)
- Рандомный криптографически стойкий токен
- Хранится в базе данных с привязкой к устройству и IP
- Используется для получения нового access token
- Может быть отозван администратором или пользователем
- Реализует концепцию "одноразового использования" - при обновлении создается новый

## Процесс аутентификации

### Регистрация

1. Клиент отправляет учетные данные (username, email, password)
2. Сервер валидирует данные
3. Пароль хешируется с использованием bcrypt
4. Создается запись пользователя в БД
5. Генерируются initial access и refresh токены
6. Refresh токен сохраняется в БД с привязкой к устройству
7. Токены возвращаются клиенту (JSON или cookies)

### Вход

1. Клиент отправляет учетные данные (email/username и password)
2. Сервер валидирует данные и проверяет хеш пароля
3. Генерируются новые access и refresh токены
4. Refresh токен сохраняется в БД с привязкой к устройству
5. Токены возвращаются клиенту (JSON или cookies)

### Обновление токенов

1. Клиент отправляет refresh token + CSRF token (для Cookie-based auth)
2. Сервер проверяет валидность refresh token в базе данных
3. Старый refresh token помечается как истекший (soft delete)
4. Генерируются новые access и refresh токены
5. Новый refresh token сохраняется в БД с привязкой к устройству
6. Новые токены возвращаются клиенту

### Выход из системы

1. Клиент отправляет запрос на выход с refresh token
2. Сервер помечает refresh token как истекший в БД
3. JWT токены для данного пользователя инвалидируются (при необходимости)
4. Cookies очищаются (для Cookie-based auth)

## Защита от CSRF-атак

Для Cookie-based аутентификации реализована защита от CSRF-атак:

1. При аутентификации генерируется уникальный CSRF-токен
2. CSRF-токен передается клиенту в теле ответа (не в cookie)
3. Клиент должен включать CSRF-токен в заголовок X-CSRF-Token для всех модифицирующих запросов
4. Сервер проверяет соответствие CSRF-токена текущему пользователю
5. CSRF-токены имеют ограниченное время жизни

## Ротация JWT-ключей

Для повышения безопасности реализована система ротации ключей JWT:

1. Каждый JWT-ключ имеет уникальный идентификатор (kid)
2. Ключи периодически обновляются (настраиваемый интервал)
3. Старые ключи поддерживаются некоторое время для обеспечения плавного перехода
4. Ротация может быть вызвана принудительно администратором
5. Клиенты уведомляются о необходимости обновления токенов через WebSocket

## Управление сессиями

Система поддерживает управление сессиями пользователя:

1. Каждый refresh token связан с конкретным устройством
2. Пользователь может просматривать список активных сессий
3. Возможен выход с конкретного устройства или со всех устройств
4. Администратор может принудительно завершить сессии пользователя
5. Для каждой сессии хранится информация о IP, устройстве и времени доступа

## Примеры использования

### Аутентификация (Cookie-based)

```http
POST /api/auth/login
Content-Type: application/json

{
  "email": "user@example.com",
  "password": "secure_password",
  "device_id": "browser-fingerprint-xyz"
}
```

Ответ:

```http
HTTP/1.1 200 OK
Content-Type: application/json
Set-Cookie: access_token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...; HttpOnly; Secure; SameSite=Strict
Set-Cookie: refresh_token=b9a315e8db9b4e7c8e0e1c9acf15dfa6; HttpOnly; Secure; SameSite=Strict

{
  "user": {
    "id": 123,
    "username": "user123",
    "email": "user@example.com"
  },
  "csrf_token": "8f1b7c6e9d2a4f3c8e1d6a7b5c9e3f2d"
}
```

### Обновление токенов

```http
POST /api/auth/refresh
Content-Type: application/json
Cookie: refresh_token=b9a315e8db9b4e7c8e0e1c9acf15dfa6
X-CSRF-Token: 8f1b7c6e9d2a4f3c8e1d6a7b5c9e3f2d
```

Ответ:

```http
HTTP/1.1 200 OK
Content-Type: application/json
Set-Cookie: access_token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...; HttpOnly; Secure; SameSite=Strict
Set-Cookie: refresh_token=e1c9acf15dfa6b9a315e8db9b4e7c8e0; HttpOnly; Secure; SameSite=Strict

{
  "csrf_token": "7b5c9e3f2d8f1b7c6e9d2a4f3c8e1d6a"
}
```

### Получение списка активных сессий

```http
GET /api/auth/sessions
Cookie: access_token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
X-CSRF-Token: 7b5c9e3f2d8f1b7c6e9d2a4f3c8e1d6a
```

Ответ:

```http
HTTP/1.1 200 OK
Content-Type: application/json

{
  "sessions": [
    {
      "id": 1,
      "device_id": "browser-fingerprint-xyz",
      "ip_address": "192.168.1.1",
      "user_agent": "Mozilla/5.0 ...",
      "created_at": "2023-03-15T12:34:56Z",
      "last_used_at": "2023-03-26T10:11:12Z"
    },
    {
      "id": 2,
      "device_id": "mobile-device-abc",
      "ip_address": "10.0.0.1",
      "user_agent": "Mobile App/1.0",
      "created_at": "2023-03-20T09:08:07Z",
      "last_used_at": "2023-03-25T14:15:16Z"
    }
  ]
}
```

## Рекомендации по безопасности

1. Используйте Cookie-based аутентификацию для веб-приложений
2. Всегда передавайте CSRF-токен для модифицирующих запросов
3. Используйте HTTPS для всех коммуникаций
4. Для повышения безопасности ограничьте количество активных сессий пользователя
5. Регулярно проверяйте список активных сессий и выходите из неизвестных устройств
6. Реализуйте систему уведомлений о подозрительных входах

## Конфигурация

Настройки аутентификации могут быть изменены через config.yaml:

```yaml
auth:
  # Настройки JWT
  jwt:
    secret: "your-secret-key"          # Секретный ключ для подписи JWT (в production использовать env var)
    expiration_minutes: 30             # Время жизни access токена в минутах
    key_rotation_days: 7               # Интервал ротации JWT ключей в днях
    max_active_keys: 3                 # Максимальное количество активных ключей
  
  # Настройки refresh токенов
  refresh_token:
    length: 32                         # Длина refresh токена в байтах
    expiration_days: 30                # Время жизни refresh токена в днях
    max_per_user: 10                   # Максимальное количество активных сессий на пользователя
  
  # Настройки cookies
  cookies:
    secure: true                       # Использовать Secure флаг (только HTTPS)
    same_site: "strict"                # SameSite политика (lax, strict, none)
    domain: "yourdomain.com"           # Домен для cookies (опционально)
    path: "/"                          # Путь для cookies
  
  # Настройки CSRF защиты  
  csrf:
    token_length: 32                   # Длина CSRF токена в байтах
    header_name: "X-CSRF-Token"        # Имя заголовка для CSRF токена
    expiration_hours: 24               # Время жизни CSRF токена
``` 