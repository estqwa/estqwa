# Система управления викторинами (QuizManager)

## Обзор

QuizManager представляет собой комплексный сервис для управления полным жизненным циклом викторин. Он координирует работу различных подсистем, обеспечивая своевременную доставку вопросов участникам, обработку ответов и подведение итогов викторины.

## Архитектура

QuizManager построен на модульной архитектуре с четким разделением обязанностей:

```
                    ┌───────────────────┐
                    │     QuizManager   │
                    └─────────┬─────────┘
                              │
               ┌──────────────┼──────────────┐
               │              │              │
    ┌──────────▼──────┐ ┌─────▼──────┐ ┌─────▼───────────┐
    │    Scheduler    │ │ Question   │ │ AnswerProcessor │
    │                 │ │ Manager    │ │                 │
    └─────────────────┘ └────────────┘ └─────────────────┘
               │              │              │
               │              │              │
    ┌──────────▼──────┐ ┌─────▼──────┐ ┌─────▼───────────┐
    │  QuizRepository │ │ WebSocket  │ │  ResultService  │
    └─────────────────┘ │ Manager    │ └─────────────────┘
                        └────────────┘
```

### Основные компоненты

#### QuizManager

Центральный компонент, который:
- Координирует работу всех подкомпонентов
- Обрабатывает внешние события (запуск/отмена викторины)
- Управляет состоянием активных викторин
- Обеспечивает асинхронную обработку через каналы Go
- Предоставляет API для внешних сервисов

#### Scheduler (Планировщик)

Управляет временными аспектами викторины:
- Планирование викторин на определенное время
- Отмена запланированных викторин
- Автоматический запуск викторины в назначенное время
- Управление последовательностью событий (анонс, ожидание, обратный отсчет)
- Отправка уведомлений перед началом викторины
- Таймеры для контроля продолжительности различных фаз

#### QuestionManager (Менеджер вопросов)

Управляет вопросами викторины:
- Загрузка вопросов из базы данных
- Управление очередностью вопросов
- Отправка вопросов участникам в реальном времени
- Таймеры для каждого вопроса
- Отправка правильных ответов после истечения времени
- Форматирование вопросов для фронтенда

#### AnswerProcessor (Обработчик ответов)

Обрабатывает ответы пользователей:
- Приём и валидация ответов от пользователей
- Проверка правильности ответов
- Расчет баллов с учетом времени ответа
- Обновление рейтинга участников в реальном времени
- Определение выбывших/активных участников
- Интеграция с ResultService для сохранения результатов

## Жизненный цикл викторины

Система управляет следующими этапами викторины:

1. **Создание и настройка**
   - Создание викторины с параметрами (название, описание, время)
   - Добавление вопросов к викторине
   - Настройка параметров (длительность, стоимость вопросов)

2. **Планирование**
   - Установка времени проведения викторины
   - Отправка уведомлений заинтересованным пользователям
   - Возможность отмены/переноса запланированной викторины

3. **Фаза ожидания**
   - Отображение обратного отсчета до начала
   - Отправка уведомлений (за 24 часа, 1 час, 10 минут до начала)
   - Сбор предварительных регистраций участников

4. **Активная фаза**
   - Запуск викторины в указанное время
   - Последовательное отправление вопросов
   - Контроль времени ответа на каждый вопрос
   - Обработка ответов участников в реальном времени
   - Обновление рейтинга после каждого вопроса
   - Обработка выхода/присоединения участников

5. **Завершение**
   - Подсчет финальных результатов
   - Определение победителей
   - Обновление статистики пользователей
   - Архивирование результатов викторины
   - Отправка уведомлений с результатами

## Обработка событий

QuizManager использует событийно-ориентированную архитектуру с асинхронной обработкой через каналы:

```go
type QuizEvent struct {
    Type    QuizEventType
    QuizID  uint
    Payload interface{}
}

// Пример типов событий
const (
    EventQuizScheduled QuizEventType = "quiz_scheduled"
    EventQuizStarted   QuizEventType = "quiz_started"
    EventQuizCancelled QuizEventType = "quiz_cancelled"
    EventQuestionNext  QuizEventType = "question_next"
    EventQuestionEnd   QuizEventType = "question_end"
    EventQuizFinished  QuizEventType = "quiz_finished"
    EventUserAnswer    QuizEventType = "user_answer"
)
```

Система обработки событий:
- Обеспечивает слабое связывание компонентов
- Позволяет масштабировать систему горизонтально
- Обеспечивает отказоустойчивость (повторная попытка обработки)
- Поддерживает транзакционную модель событий

## Планирование викторин

Scheduler использует несколько механизмов планирования:

### Ближайшее планирование (in-memory)

Для викторин, запланированных в ближайшие 24 часа:
- Таймеры Go с точным временем срабатывания
- Быстрое реагирование на изменения
- Устойчивость к перезагрузке сервера (восстановление из БД)

### Долгосрочное планирование (persistent)

Для викторин, запланированных в будущем:
- Хранение в БД с индексированием по времени
- Периодическая проверка и загрузка в ближайшее планирование
- Поддержка повторяющихся викторин

### Обработка часовых поясов

- Все метки времени хранятся в UTC
- Система учитывает часовой пояс пользователя при отображении времени
- Автоматическая адаптация к переходу на летнее/зимнее время

## Управление вопросами

QuestionManager обеспечивает последовательную доставку вопросов:

```
┌───────────────┐       ┌────────────────┐
│ Question 1    │──────►│ Waiting period │
│ (30 seconds)  │       │ (5 seconds)    │
└───────┬───────┘       └────────┬───────┘
        │                        │
        ▼                        ▼
┌───────────────┐       ┌────────────────┐
│ Answers &     │──────►│ Question 2     │
│ Explanation   │       │ (30 seconds)   │
│ (10 seconds)  │       └────────────────┘
└───────────────┘
```

Особенности:
- Настраиваемая длительность вопросов (10-60 секунд)
- Период ожидания между вопросами для снижения нагрузки
- Показ правильных ответов и объяснений
- Адаптивная сложность вопросов (опционально)
- Рандомизация порядка вопросов и вариантов ответов

## Обработка ответов

AnswerProcessor использует алгоритм расчета баллов, учитывающий:
- Правильность ответа
- Время ответа
- Сложность вопроса
- Последовательность правильных ответов (комбо-бонусы)

Формула расчета баллов:
```
score = basePoints * (1 + (maxTimeBonus - timeUsed/totalTime) * timeWeightFactor)
```

Где:
- basePoints - базовая стоимость вопроса
- maxTimeBonus - максимальный бонус за скорость (обычно 0.5)
- timeUsed - время, затраченное на ответ в миллисекундах
- totalTime - общее доступное время для ответа
- timeWeightFactor - вес временного фактора (от 0.5 до 1.0)

## Интеграция с WebSocket

QuizManager тесно интегрирован с WebSocket подсистемой:

- Все события викторины отправляются через WebSocket
- Поддерживается приоритизация сообщений (критичные сообщения о времени)
- Обеспечивается синхронизация между шардами через Redis PubSub
- Реализована устойчивость к кратковременным отключениям клиентов

Основные типы сообщений через WebSocket:
- QUIZ_START - уведомление о начале викторины
- QUIZ_END - уведомление о завершении викторины
- QUESTION_START - отправка нового вопроса
- QUESTION_END - завершение времени на вопрос
- USER_ANSWER - получение ответа пользователя
- RESULT_UPDATE - обновление рейтинга участников

## Интеграция с базой данных

Система взаимодействует с несколькими репозиториями:

- **QuizRepository** - хранение и получение викторин и их параметров
- **QuestionRepository** - хранение и получение вопросов
- **UserAnswerRepository** - сохранение ответов пользователей
- **ResultRepository** - сохранение и получение результатов викторины

## Отказоустойчивость

QuizManager обеспечивает высокую отказоустойчивость:

- Восстановление состояния после перезапуска сервера
- Обработка отключений пользователей с возможностью восстановления сессии
- Механизм дедупликации ответов пользователей
- Асинхронное сохранение результатов для снижения нагрузки на БД
- Репликация критичных данных через Redis для кластерной работы

## Расширение и масштабирование

Архитектура поддерживает:

- Горизонтальное масштабирование с распределением нагрузки
- Добавление новых типов вопросов (множественный выбор, сопоставление и т.д.)
- Поддержку различных форматов викторин (классическая, с выбыванием, командная)
- Интеграцию с внешними системами для импорта/экспорта вопросов

## Конфигурация

Настройки QuizManager могут быть изменены через config.yaml:

```yaml
quiz_manager:
  # Настройки планировщика
  scheduler:
    notification_times: [86400, 3600, 600]  # Уведомления за N секунд до начала
    max_active_quizzes: 5                   # Максимальное число одновременных викторин
    poll_interval_seconds: 60               # Интервал проверки планировщика
  
  # Настройки вопросов
  questions:
    default_time_limit_sec: 30              # Время на вопрос по умолчанию
    waiting_period_sec: 5                   # Период ожидания между вопросами
    explanation_time_sec: 10                # Время показа правильного ответа
    
  # Настройки подсчета баллов  
  scoring:
    default_base_points: 10                 # Базовая стоимость вопроса
    time_weight_factor: 0.7                 # Вес временного фактора
    combo_bonus_enabled: true               # Включение комбо-бонусов
    combo_bonus_factor: 0.1                 # Множитель комбо-бонуса
    
  # Прочие настройки
  misc:
    user_answer_buffer_size: 1000           # Размер буфера для ответов пользователей
    event_buffer_size: 500                  # Размер буфера событий
    results_autosave_interval_sec: 30       # Интервал автосохранения результатов
```

## Пример использования API

### Создание и настройка викторины

```http
POST /api/quizzes
Content-Type: application/json
Authorization: Bearer eyJhbGciOiJIUzI1...

{
  "title": "География мира",
  "description": "Викторина о странах и континентах",
  "scheduled_time": "2023-04-15T18:00:00Z",
  "questions": [
    {
      "text": "Какая страна является самой большой по площади?",
      "options": ["Китай", "США", "Россия", "Канада"],
      "correct_option": 2,
      "time_limit_sec": 20,
      "point_value": 10
    },
    // Другие вопросы...
  ]
}
```

### Планирование викторины

```http
PUT /api/quizzes/123/schedule
Content-Type: application/json
Authorization: Bearer eyJhbGciOiJIUzI1...

{
  "scheduled_time": "2023-04-15T18:00:00Z"
}
```

### Отмена викторины

```http
PUT /api/quizzes/123/cancel
Authorization: Bearer eyJhbGciOiJIUzI1...
```

### Получение результатов

```http
GET /api/quizzes/123/results
Authorization: Bearer eyJhbGciOiJIUzI1...
```

Ответ:

```json
{
  "quiz_id": 123,
  "title": "География мира",
  "total_participants": 150,
  "leaderboard": [
    {
      "position": 1,
      "user_id": 456,
      "username": "geo_master",
      "score": 580,
      "correct_answers": 10
    },
    {
      "position": 2,
      "user_id": 789,
      "username": "travel_expert",
      "score": 540,
      "correct_answers": 9
    }
    // Остальные участники...
  ]
}
```

