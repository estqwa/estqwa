# Trivia API

## Обзор проекта

Trivia API - это API-сервер для онлайн-викторин, разработанный на Go с использованием современных технологий и практик. Система позволяет проводить викторины в реальном времени с большим количеством участников, отслеживать результаты и вести статистику.

## Основные технологии

- **Go** - основной язык программирования
- **Gin** - веб-фреймворк
- **GORM** - ORM для работы с базой данных
- **PostgreSQL** - реляционная база данных
- **Redis** - кеширование и распределенное взаимодействие
- **JWT** - аутентификация и авторизация
- **WebSocket** - коммуникация в реальном времени

## Архитектура

Проект следует принципам чистой архитектуры и разделен на следующие слои:

### Доменный слой (Domain)

Содержит базовые сущности и интерфейсы репозиториев:

#### Основные сущности:

- **User** - пользователь системы
- **Quiz** - викторина с вопросами
- **Question** - вопрос викторины с вариантами ответов
- **Result** - результат участия пользователя в викторине
- **UserAnswer** - ответ пользователя на конкретный вопрос
- **RefreshToken** - токен обновления для авторизации
- **InvalidToken** - запись об инвалидированном токене

#### Репозитории:

- **UserRepository** - работа с пользователями
- **QuizRepository** - работа с викторинами
- **QuestionRepository** - работа с вопросами
- **ResultRepository** - работа с результатами
- **CacheRepository** - доступ к кешу
- **RefreshTokenRepository** - управление refresh-токенами
- **InvalidTokenRepository** - работа с инвалидированными токенами

### Слой инфраструктуры (Infrastructure)

#### Репозитории PostgreSQL:
- **UserRepo** - реализация репозитория пользователей:
  - Создание и получение пользователей (по ID, email, username)
  - Безопасное обновление паролей с хешированием через bcrypt
  - Обновление профиля и статистики пользователей
  - Инкрементация количества сыгранных игр и обновление счета
  
- **QuizRepo** - реализация репозитория викторин:
  - Создание викторин и добавление вопросов
  - Получение активных и запланированных викторин
  - Управление статусом викторины (scheduled, in_progress, completed)
  - Загрузка викторин с вопросами для клиента

- **QuestionRepo** - реализация репозитория вопросов:
  - Создание единичных вопросов и пакетная загрузка
  - Получение вопросов по ID и по викторине
  - Получение случайных вопросов для тестирования
  - Обработка UTF-8 кодировки для многоязычного контента

- **ResultRepo** - реализация репозитория результатов:
  - Сохранение ответов пользователей и итоговых результатов
  - Получение статистики по пользователям и викторинам
  - Расчет рангов участников викторины
  - Определение победителей и распределение призового фонда

- **RefreshTokenRepo** - реализация репозитория токенов обновления:
  - Создание и проверка refresh-токенов
  - Управление сроком действия токенов
  - Логирование устройств и IP-адресов для аудита
  - Ограничение количества активных сессий
  - Очистка устаревших токенов для оптимизации БД

- **InvalidTokenRepo** - реализация репозитория инвалидированных токенов:
  - Добавление и удаление записей инвалидации
  - Проверка токенов на инвалидацию (при смене пароля/принудительном выходе)
  - Очистка устаревших записей инвалидации

#### Репозиторий Redis:
- **CacheRepo** - реализация кеш-репозитория:
  - Сохранение и получение кешированных данных
  - Работа с примитивными типами и JSON-структурами
  - Поддержка TTL (Time To Live) для автоматической очистки устаревших данных
  - Атомарные операции инкремента для счетчиков

#### WebSocket:
Подсистема WebSocket обеспечивает высокопроизводительную двунаправленную коммуникацию в реальном времени и имеет следующие компоненты:

##### Основные компоненты:
- **Client** - представляет WebSocket соединение с пользователем:
  - Обработка чтения и записи сообщений
  - Поддержка подписок на типы сообщений
  - Управление таймаутами и периодическими пингами
  - Отслеживание активности пользователя

- **Hub** - центральный компонент управления соединениями:
  - Регистрация и отмена регистрации клиентов
  - Широковещательная рассылка сообщений
  - Отправка сообщений конкретным пользователям
  - Мониторинг состояния соединений

- **ShardedHub** - улучшенная версия Hub с шардированием:
  - Распределение клиентов по шардам
  - Горизонтальное масштабирование с поддержкой кластеризации
  - Балансировка нагрузки между шардами
  - Отказоустойчивость при высоких нагрузках

- **Manager** - управление бизнес-логикой сообщений:
  - Обработка входящих сообщений от клиентов
  - Приоритизация исходящих сообщений
  - Регистрация обработчиков разных типов сообщений
  - Управление очередями сообщений

##### Особенности реализации:
- **Шардирование**: горизонтальное масштабирование до десятков тысяч одновременных соединений
  - Настраиваемое количество шардов (по умолчанию 8)
  - Максимальное количество клиентов на шард (по умолчанию 2000)
  - Автоматическое балансирование нагрузки между шардами
  - Миграция клиентов при необходимости

- **Кластеризация**: поддержка распределенного режима работы через Redis Pub/Sub
  - Синхронизация сообщений между серверами
  - Механизм предотвращения дублирования сообщений
  - Обмен метриками между экземплярами
  - Прозрачная маршрутизация сообщений к пользователям в кластере

- **Оптимизация производительности**:
  - Пул воркеров для параллельной обработки задач
  - Пакетная обработка сообщений для снижения overhead
  - Приоритеты сообщений (критические, высокие, нормальные, низкие)
  - Эффективное управление неактивными соединениями
  - Обработка массовых отключений без блокировки системы

- **Мониторинг и метрики**:
  - Детальные метрики в форматах JSON и Prometheus
  - Отслеживание активности пользователей
  - Обнаружение "горячих" шардов с высокой нагрузкой
  - Система алертов и уведомлений

##### Типы сообщений:
- **Событийные сообщения викторины**: QUIZ_START, QUIZ_END, QUESTION_START, QUESTION_END
- **Сообщения пользователей**: USER_ANSWER, RESULT_UPDATE
- **Системные сообщения**: TOKEN_EXPIRE_SOON, TOKEN_EXPIRED

##### API и интеграция:
- WebSocket endpoint для клиентских подключений
- HTTP-маршруты для мониторинга и метрик
- Интерфейс для интеграции с системами проверки работоспособности
- Поддержка форматов JSON и Prometheus для метрик

### Прикладной слой (Application)

#### Сервисы:
- **AuthService** - сервис аутентификации и авторизации:
  - Регистрация и аутентификация пользователей
  - Управление JWT-токенами (создание, обновление, инвалидация)
  - Управление refresh-токенами и сессиями пользователей
  - Изменение и сброс паролей
  - Выход из системы с одного или всех устройств
  - Отладка и анализ токенов
  - Поддержка двух режимов аутентификации (cookie и Bearer)

- **QuizService** - сервис управления викторинами:
  - Создание и планирование викторин
  - Добавление вопросов к викторине
  - Получение информации о викторинах (активных, запланированных)
  - Управление жизненным циклом викторины
  - Валидация вопросов и параметров викторины

- **ResultService** - сервис обработки результатов:
  - Обработка ответов пользователей на вопросы
  - Подсчет баллов с учетом времени ответа
  - Формирование и сохранение итоговых результатов викторины
  - Расчет статистики участников
  - Обновление рейтинга и статистики пользователей

- **QuizManager** - комплексный сервис для управления жизненным циклом викторин:
  - Координация работы всех подсистем викторины
  - Обработка событий от внутренних компонентов
  - Планирование и запуск викторин в назначенное время
  - Отмена запланированных викторин
  - Обработка ответов пользователей в реальном времени
  - Завершение викторины и подведение итогов
  - Асинхронная обработка событий через каналы Go
  
  #### Подкомпоненты QuizManager:
  - **Scheduler** - планировщик викторин:
    - Планирование и отмена викторин
    - Отправка уведомлений перед началом викторины
    - Автоматический запуск викторины в назначенное время
    - Последовательность событий (анонс, зал ожидания, обратный отсчет)
    - Синхронизация с точным временем начала

  - **QuestionManager** - менеджер вопросов:
    - Отправка вопросов участникам в реальном времени
    - Автоматическое заполнение викторины вопросами
    - Управление таймерами для каждого вопроса
    - Форматирование вопросов для фронтенда
    - Отправка правильных ответов после истечения времени

  - **AnswerProcessor** - обработчик ответов:
    - Проверка правильности ответов пользователей
    - Расчет набранных баллов с учетом времени ответа
    - Обработка событий готовности пользователей
    - Определение выбывших участников
    - Отправка результатов ответа пользователю

#### Обработчики (Handlers):
- **AuthHandler** - обработчики аутентификации и авторизации:
  - Регистрация и вход пользователей
  - Обновление и проверка токенов
  - Управление сессиями (получение, отзыв, выход из всех устройств)
  - Поддержка двух режимов аутентификации: через cookies и через Bearer-токены
  - Защита от CSRF-атак
  - Смена пароля и сброс аутентификации
  - Административные функции (сброс пароля пользователя, отладка токенов)

- **QuizHandler** - обработчики для управления викторинами:
  - Создание и получение викторин
  - Добавление вопросов к викторине
  - Планирование и отмена викторин
  - Получение результатов викторин
  - Пагинация списка викторин
  - Получение активных и запланированных викторин

- **WSHandler** - обработчики WebSocket соединений:
  - Обработка WebSocket подключений с проверкой JWT
  - Регистрация обработчиков сообщений от клиентов
  - Обработка событий готовности пользователя
  - Обработка ответов на вопросы в реальном времени
  - Поддержка heartbeat для проверки соединения

#### Middleware:
- **AuthMiddleware** - промежуточное ПО для аутентификации:
  - Проверка JWT токенов (из cookies или заголовка Authorization)
  - Добавление информации о пользователе в контекст запроса
  - Проверка прав администратора
  - Поддержка различных сценариев ошибок аутентификации
  - Обратная совместимость с Bearer-токенами

### Конфигурация

Система настраивается через YAML-файл и переменные окружения и включает следующие разделы:
- Настройки сервера
- Настройки баз данных (PostgreSQL и Redis)
- Настройки JWT
- Настройки аутентификации
- Настройки WebSocket (шардирование, кластеризация, буферы)

## Основные функциональные возможности

### Аутентификация
- Регистрация и вход пользователей
- Поддержка refresh-токенов для безопасной авторизации
- Управление активными сессиями
- Безопасный выход и выход со всех устройств
- Инвалидация токенов при смене пароля
- Поддержка двух механизмов аутентификации:
  - Современный подход через HttpOnly cookies с защитой от CSRF
  - Традиционный подход через Bearer-токены (для обратной совместимости)

### Викторины
- Создание и управление викторинами
- Планирование викторин на определенное время
- Автоматический запуск и завершение викторин
- Поддержка различных типов вопросов
- Ограничение времени ответа на вопросы
- Пошаговая проверка ответов и подсчет очков

### Реальное время
- WebSocket соединения для обновлений в реальном времени
- Вывод текущих результатов
- Объявление победителей
- Отслеживание прогресса викторины
- Мгновенная обработка ответов пользователей
- Система оповещений для пользователей

### Масштабируемость
- Шардирование WebSocket соединений
- Кластеризация через Redis PubSub
- Оптимизация для высоких нагрузок
- Мониторинг и балансировка

## Особенности безопасности

- Хеширование паролей с использованием bcrypt
- JWT с поддержкой инвалидации токенов
- Защита от CSRF атак
- Ограничение количества сессий на пользователя
- Отслеживание IP-адресов и устройств
- Управление сессиями пользователей с возможностью отзыва
- Механизм обновления токенов с проверкой CSRF

## Хранение данных и кеширование

### PostgreSQL
- Хранение всех основных сущностей и их взаимосвязей
- Транзакционная обработка операций для обеспечения целостности данных
- Использование индексов для оптимизации производительности запросов
- Поддержка JSON-типов для хранения сложных структур (варианты ответов)
- Поддержка многоязычного контента с UTF-8 кодировкой

#### Схема базы данных:

##### Таблица `users`
- `id`: SERIAL PRIMARY KEY - уникальный идентификатор пользователя
- `username`: VARCHAR(50) NOT NULL UNIQUE - уникальное имя пользователя
- `email`: VARCHAR(100) NOT NULL UNIQUE - уникальный email пользователя
- `password`: VARCHAR(100) NOT NULL - хешированный пароль
- `profile_picture`: VARCHAR(255) - путь к изображению профиля
- `games_played`: INT - количество сыгранных игр
- `total_score`: INT - общий набранный счет
- `highest_score`: INT - наивысший счет
- `created_at`, `updated_at`: TIMESTAMP WITH TIME ZONE - время создания и обновления записи

##### Таблица `quizzes`
- `id`: SERIAL PRIMARY KEY - уникальный идентификатор викторины
- `title`: VARCHAR(100) NOT NULL - название викторины
- `description`: VARCHAR(500) - описание викторины
- `scheduled_time`: TIMESTAMP WITH TIME ZONE NOT NULL - запланированное время начала
- `status`: VARCHAR(20) NOT NULL - статус викторины (scheduled, in_progress, completed)
- `question_count`: INT - количество вопросов
- `created_at`, `updated_at`: TIMESTAMP WITH TIME ZONE - время создания и обновления записи

##### Таблица `questions`
- `id`: SERIAL PRIMARY KEY - уникальный идентификатор вопроса
- `quiz_id`: INT NOT NULL - ссылка на викторину (внешний ключ)
- `text`: VARCHAR(500) NOT NULL - текст вопроса
- `options`: JSONB NOT NULL - варианты ответов в формате JSON
- `correct_option`: INT NOT NULL - индекс правильного ответа
- `time_limit_sec`: INT NOT NULL - ограничение времени на ответ в секундах
- `point_value`: INT NOT NULL - базовая стоимость вопроса в очках
- `created_at`, `updated_at`: TIMESTAMP WITH TIME ZONE - время создания и обновления записи

##### Таблица `user_answers`
- `id`: SERIAL PRIMARY KEY - уникальный идентификатор ответа
- `user_id`: INT NOT NULL - ссылка на пользователя (внешний ключ)
- `quiz_id`: INT NOT NULL - ссылка на викторину (внешний ключ)
- `question_id`: INT NOT NULL - ссылка на вопрос (внешний ключ)
- `selected_option`: INT NOT NULL - выбранный вариант ответа
- `is_correct`: BOOLEAN NOT NULL - флаг правильности ответа
- `response_time_ms`: BIGINT NOT NULL - время ответа в миллисекундах
- `score`: INT NOT NULL - начисленные очки
- `created_at`: TIMESTAMP WITH TIME ZONE - время создания записи

##### Таблица `results`
- `id`: SERIAL PRIMARY KEY - уникальный идентификатор результата
- `user_id`: INT NOT NULL - ссылка на пользователя (внешний ключ)
- `quiz_id`: INT NOT NULL - ссылка на викторину (внешний ключ)
- `username`: VARCHAR(50) NOT NULL - имя пользователя (денормализация для производительности)
- `profile_picture`: VARCHAR(255) - путь к изображению профиля (денормализация)
- `score`: INT NOT NULL - итоговый счет
- `correct_answers`: INT NOT NULL - количество правильных ответов
- `total_questions`: INT NOT NULL - общее количество вопросов
- `rank`: INT - место в рейтинге участников викторины
- `completed_at`: TIMESTAMP WITH TIME ZONE NOT NULL - время завершения викторины
- `created_at`: TIMESTAMP WITH TIME ZONE - время создания записи

##### Таблица `invalid_tokens`
- `user_id`: INT NOT NULL PRIMARY KEY - идентификатор пользователя (внешний ключ)
- `invalidation_time`: TIMESTAMP WITH TIME ZONE NOT NULL - время инвалидации токенов

##### Таблица `refresh_tokens`
- `id`: SERIAL PRIMARY KEY - уникальный идентификатор токена
- `user_id`: INT NOT NULL - ссылка на пользователя (внешний ключ)
- `token`: TEXT NOT NULL UNIQUE - уникальный токен обновления
- `device_id`: VARCHAR(255) NOT NULL - идентификатор устройства
- `ip_address`: VARCHAR(50) - IP-адрес, с которого был получен токен
- `user_agent`: TEXT - информация о браузере/устройстве
- `expires_at`: TIMESTAMP WITH TIME ZONE NOT NULL - время истечения токена
- `is_expired`: BOOLEAN NOT NULL DEFAULT FALSE - флаг истечения токена (помечает токен как истёкший вместо его удаления)
- `created_at`: TIMESTAMP WITH TIME ZONE - время создания токена

#### Индексы для оптимизации запросов:
- `idx_user_answers_user_id` на `user_answers (user_id)`
- `idx_user_answers_quiz_id` на `user_answers (quiz_id)`
- `idx_results_quiz_id` на `results (quiz_id)`
- `idx_results_user_id` на `results (user_id)`
- `idx_questions_quiz_id` на `questions (quiz_id)`
- `idx_quizzes_status` на `quizzes (status)` 
- `idx_quizzes_scheduled_time` на `quizzes (scheduled_time)`
- `idx_refresh_tokens_token` на `refresh_tokens (token)`
- `idx_refresh_tokens_user_id` на `refresh_tokens (user_id)`
- `idx_refresh_tokens_not_expired` на `refresh_tokens (user_id, is_expired)` с условием `WHERE is_expired = FALSE`

### Redis
- Кеширование часто запрашиваемых данных для снижения нагрузки на БД
- Временное хранение состояния активных викторин
- Атомарные операции для счетчиков и анализа данных
- Хранение и передача WebSocket сообщений в кластерной конфигурации
- Автоматическое устаревание данных через TTL (Time To Live)

## Утилитарные пакеты

### Пакет auth

Пакет `auth` обеспечивает полноценную систему аутентификации и авторизации с расширенной функциональностью.

#### JWTService (jwt.go)
Сервис для работы с JWT-токенами:
- Генерация JWT-токенов с пользовательскими клеймами (UserID, Email)
- Проверка и расшифровка токенов с валидацией подписи
- Инвалидация токенов для пользователя (при смене пароля или выходе)
- Двухуровневая система инвалидации токенов:
  - In-memory кеш для быстрой проверки
  - Персистентное хранение инвалидированных токенов в базе данных
- Автоматическая очистка устаревших записей инвалидации (48 часов)
- Диагностика токенов для отладки проблем аутентификации

#### TokenService (token_service.go)
Сервис для работы с refresh-токенами:
- Генерация пар токенов (JWT access token + refresh token)
- Проверка и обновление refresh-токенов
- Управление жизненным циклом токенов (с настраиваемым временем жизни)
- Лимитирование количества активных сессий на пользователя 
- Отзыв токенов (отдельного токена или всех для пользователя)
- Получение информации о сроках действия токенов
- Очистка истекших токенов для оптимизации БД

#### TokenManager (token_manager.go)
Комплексный менеджер токенов, интегрирующий JWTService и TokenService:
- Генерация и обновление пар токенов с привязкой к устройству
- Управление CSRF-токенами для защиты от атак
- Ротация JWT ключей для повышения безопасности
- Поддержка двух режимов аутентификации:
  - Cookie-based: HttpOnly cookies + CSRF токен
  - Bearer: классический подход с токенами в заголовках
- Управление cookie (установка, получение, очистка)
- Настраиваемые параметры безопасности:
  - Время жизни токенов
  - Лимит активных сессий на пользователя
  - Интервал ротации ключей
- Детальная обработка ошибок с типизацией
- Поддержка проверок работоспособности и диагностики

### Пакет database

Пакет `database` содержит утилиты для работы с PostgreSQL и Redis.

#### PostgreSQL (postgres.go)
Утилиты для работы с PostgreSQL:
- Создание подключения к базе данных через GORM
- Оптимизация пула соединений:
  - Настройка максимального количества открытых соединений (25)
  - Настройка максимального количества простаивающих соединений (10)
  - Настройка максимального времени жизни соединения (1 час)
- Автоматическая миграция схемы базы данных через GORM
- Выполнение SQL-миграций для обновления таблиц
- Поддержка получения базового *sql.DB из *gorm.DB для прямого SQL

#### Redis (redis.go)
Утилиты для работы с Redis:
- Создание клиента Redis с настройкой подключения
- Проверка доступности сервера Redis при инициализации
- Поддержка аутентификации и выбора базы данных

## Запуск и настройка

1. Настройте конфигурационный файл config.yaml
2. Убедитесь, что PostgreSQL и Redis запущены и доступны
3. Выполните миграции базы данных с помощью инструмента миграций:
   ```
   migrate -path migrations -database "postgresql://username:password@localhost:5432/database?sslmode=disable" up
   ```
4. Запустите сервер командой: `go run cmd/api/main.go`
5. По умолчанию сервер запускается на порту 8080

### Миграции базы данных

Проект использует систему миграций для контроля версий схемы базы данных:

- **000001_init_schema** - начальная схема с основными таблицами (users, quizzes, questions, user_answers, results, invalid_tokens)
- **000002_add_refresh_tokens** - добавление таблицы для хранения refresh-токенов с привязкой к устройствам
- **000003_modify_refresh_tokens** - оптимизация работы с refresh-токенами, добавление флага is_expired

Для отката миграций используйте команду:
```
migrate -path migrations -database "postgresql://username:password@localhost:5432/database?sslmode=disable" down
```

## Масштабирование

Проект поддерживает горизонтальное масштабирование через:
- Шардирование WebSocket соединений
- Кластеризацию с использованием Redis PubSub
- Балансировку нагрузки между экземплярами

При запуске нескольких экземпляров в кластерном режиме обеспечивается синхронизация данных и сообщений между ними.

## API Endpoints

### Аутентификация
- `POST /api/auth/register` - регистрация нового пользователя
- `POST /api/auth/login` - вход в систему
- `POST /api/auth/refresh` - обновление токенов
- `POST /api/auth/logout` - выход из системы
- `POST /api/auth/check-refresh` - проверка refresh-токена
- `POST /api/auth/token-info` - информация о токене
- `POST /api/auth/logout-all` - выход со всех устройств
- `GET /api/auth/sessions` - получение активных сессий
- `POST /api/auth/revoke-session` - отзыв конкретной сессии
- `POST /api/auth/change-password` - изменение пароля

### Управление пользователями
- `GET /api/users/me` - информация о текущем пользователе
- `PUT /api/users/me` - обновление профиля пользователя

### Викторины
- `GET /api/quizzes` - список викторин
- `GET /api/quizzes/active` - активная викторина
- `GET /api/quizzes/scheduled` - запланированные викторины
- `GET /api/quizzes/:id` - информация о викторине
- `GET /api/quizzes/:id/with-questions` - викторина с вопросами
- `GET /api/quizzes/:id/results` - результаты викторины
- `GET /api/quizzes/:id/my-result` - персональный результат
- `POST /api/quizzes` - создание викторины (только для админов)
- `POST /api/quizzes/:id/questions` - добавление вопросов (только для админов)
- `PUT /api/quizzes/:id/schedule` - планирование викторины (только для админов)
- `PUT /api/quizzes/:id/cancel` - отмена викторины (только для админов)

### WebSocket
- `GET /ws` - WebSocket endpoint для коммуникации в реальном времени
- `GET /api/ws/metrics` - метрики WebSocket сервера (формат JSON или Prometheus)
- `GET /api/ws/metrics/detailed` - детальные метрики с информацией по шардам
- `GET /api/ws/health` - проверка состояния WebSocket сервера
- `GET /api/ws/alerts` - системные предупреждения и алерты
